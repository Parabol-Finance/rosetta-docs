---
title: "Block-by-block accrual"
---

| Section | Summary |
| --- | --- |
| Supply | `totalSupplyAssets`,`totalSupplyShares`|
| Borrow | `totalBorrowAssets`,`totalBorrowShares`|
|Timing: | `lastUpdate` |
|Protocol: | `fee` |
|Accrual on every block (even with no tx)| Compound borrow interest over elapsed time; mirror to supply; update `lastUpdate`. |
|Key derived reads per market | Utilization `U = B / S`; Borrow APY from curve; Supply APY adjusts for fees. |

## Accrual on every block (even with no tx)

<CodeGroup>

```python
# Calculate time elapsed since last update
elapsed = blockTimestamp - lastUpdate

# Skip if no time has passed or no borrows exist
if elapsed == 0 or totalBorrowAssets == 0:
    pass  # no-op

else:
    # Compound borrow interest over elapsed time
    interest = compound(totalBorrowAssets, borrowRate, elapsed)
    
    # Mirror the interest on both sides
    totalBorrowAssets += interest
    totalSupplyAssets += interest
    lastUpdate = blockTimestamp
```

</CodeGroup>

## Key derived reads per market

<Tabs>
  <Tab title="Utilization Calculation">
    ```python
    # Calculate utilization ratio
    utilization = totalBorrowAssets / totalSupplyAssets  # U = B / S
    ```
  </Tab>
  <Tab title="APY Calculations">
    ```python
    # Get borrow APR from utilization curve
    borrowApy = wTaylorCompounded(borrowRate, SECONDS_PER_YEAR)
    
    # Calculate supply APR (adjusted for fees)
    supplyApy = wMulDown(wMulDown(borrowApy, utilization), 10 ** 18 - fee)
    ```
  </Tab>
</Tabs>
<Note>
  _We rely on Morpho's off-chain APY calculations. For more details:_ https://docs.morpho.org/build/earn/tutorials/get-data#apy-native--rewards
</Note>

<info>
  **Why this matters**

  * We **recompute on each block** using `lastUpdate â†’ current block`, so APY **moves in quiet periods**, not only on transactions.
  * `U = B/S` updates immediately after accrual, which flows into the **supply APR** calculation and into the chart.
  * If a reorg touches recent blocks, we **replay accrual** over that window and re-stamp the **Latest Block**.
</info>

